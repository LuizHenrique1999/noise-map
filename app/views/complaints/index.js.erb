function get_noise_type(token){
  switch(token){
    case 1:
      return "Disparo de alarmes"
    case 2:
      return "Música alta"
    case 3:
      return "Obras de construção civil"
    case 4:
      return  "Ruídos de vizinhos"
    case 5:
      return  "Tráfego de veículos"
  }
}

document.querySelector("#search_address").innerHTML +=
"<%= escape_javascript(render "layouts/search_address_form",
                              is_complaint: 0,
                              div_id: 'search_address_form',
                              field_id: 'search_address_field',
                              button_id: 'search_address_button' ) %>"

document.querySelector("#create_complaint").innerHTML += "<%= escape_javascript(render "layouts/create_complaint_form") %>"

let address_field = document.querySelector('#complaint_address_field')
const latitude_field = document.querySelector('#complaint_latitude')
const longitude_field = document.querySelector('#complaint_longitude')
const noise_type_field = document.querySelector('#complaint_noise_type_id')
const description_field = document.querySelector('#complaint_description')
let message = ""

const mapPin = L.icon({
    iconUrl: '<%= asset_path "map-pin-solid.svg" %>',
    iconSize:     [38, 95], // size of the icon
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

const complaintIcon = L.icon({
    iconUrl: '<%= asset_path "map-marker-alt-solid.svg" %>',
    iconSize: [25, 41],
    iconAnchor: [12, 37],
    popupAnchor: [1, -34],
    tooltipAnchor: [16, -28]
});

const marker = L.marker([0,0], { draggable: 'true', icon: mapPin })
             .bindPopup('Clique e movimente o marcador para aumentar a precisão do endereço')
 
marker.on('dragend', function(event) {
  latitude_field.value = event.target._latlng.lat
  longitude_field.value = event.target._latlng.lng
});

const clusterLayer = L.markerClusterGroup();

const config = {
  "radius": 0.0016,
  "maxOpacity": .7,
  "scaleRadius": true,
  "useLocalExtrema": true,
};

const heatmapLayer = new HeatmapOverlay(config);
const heatmapData = { max: 8, data: [] };

let complaints = <%= raw  @all_complaints.to_json %>
for (let i = 0; i < complaints.length; i++) {
  clusterLayer.addLayer(L.marker([complaints[i].latitude, complaints[i].longitude], { icon: complaintIcon }).bindPopup(
    "<strong>Tipo</strong> <br>" + get_noise_type(complaints[i].noise_type_id) + "<br><br>"
    + "<strong>Descrição</strong> <br>" + complaints[i].description + "<br><br>"
    + "<strong>Criado em</strong> <br>" + complaints[i].created_at ))

  heatmapData.data.push({lat: complaints[i].latitude, lng: complaints[i].longitude, value: 1})
}

map.addLayer(clusterLayer)

document.querySelector('#reset_button').addEventListener('click', function(event){
  address_field.value = ""
  address_field.classList.remove('is-danger')
  latitude_field.value = ""
  longitude_field.value = ""
  noise_type_field.value = 1
  description_field.value = ""

  message = document.querySelector("#complaint_invalid_address_message")
  message ? message.parentNode.removeChild(message) : ""
  message = document.querySelector("#complaint_invalid_coordinates_message")
  message ? message.parentNode.removeChild(message) : ""
  document.querySelector("#complaint_description").classList.remove('is-danger')

  if(map.hasLayer(marker)){
    map.removeLayer(marker)
  }
  
  sidebar.close()
})