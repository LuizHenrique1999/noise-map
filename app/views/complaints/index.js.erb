document.querySelector("#search_address").innerHTML += "<%= escape_javascript(render partial: "layouts/search_address_form") %>"
document.querySelector("#create_complaint").innerHTML += "<%= escape_javascript(render partial: "layouts/create_complaint_form") %>"

const address_field = document.querySelector('#complaint_address_text_field')
const latitude_field = document.querySelector('#complaint_latitude')
const longitude_field = document.querySelector('#complaint_longitude')
const noise_type_field = document.querySelector('#complaint_noise_type')
const description_field = document.querySelector('#complaint_description')
let message = ""

const mapPin = L.icon({
    iconUrl: '<%= asset_path "map-pin-solid.svg" %>',
    iconSize:     [38, 95], // size of the icon
    iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
    popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

const complaintIcon = L.icon({
    iconUrl: '<%= asset_path "map-marker-alt-solid.svg" %>',
    iconSize: [25, 41],
    iconAnchor: [12, 37],
    popupAnchor: [1, -34],
    tooltipAnchor: [16, -28]
});

const marker = L.marker([0,0], { draggable: 'true', icon: mapPin })
             .bindPopup('Clique e movimente o marcador para aumentar a precisão do endereço')
 
marker.on('dragend', function(event) {
  latitude_field.value = event.target._latlng.lat
  longitude_field.value = event.target._latlng.lng
});

const clusterLayer = L.markerClusterGroup();

const config = {
  "radius": 0.0016,
  "maxOpacity": .7,
  "scaleRadius": true,
  "useLocalExtrema": true,
};

const heatmapLayer = new HeatmapOverlay(config);
const heatmapData = { max: 8, data: [] };

let latitude, longitude
<% @all_complaints.each do |complaint| %>
  latitude = <%= complaint.latitude %>
  longitude = <%= complaint.longitude %>

  clusterLayer.addLayer(L.marker([latitude, longitude], { icon: complaintIcon }).bindPopup(
    "<strong>Tipo</strong> <br> <%= complaint.get_noise_type %> <br><br>"
    + "<strong>Descrição</strong> <br> <%= complaint.description %> <br><br>"
    + "<strong>Criado em</strong> <br> <%= complaint.created_at %>"))

  heatmapData.data.push({lat: latitude, lng: longitude, value: 1})
<% end %>

map.addLayer(clusterLayer)

document.querySelector('#reset_button').addEventListener('click', function(event){
  address_field.value = ""
  latitude_field.value = ""
  longitude_field.value = ""
  noise_type_field.value = 1
  description_field.value = ""

  if(map.hasLayer(marker)){
    map.removeLayer(marker)
  }
  
  sidebar.close()
})